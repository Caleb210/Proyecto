<!doctype html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <title>Mesas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://code.jquery.com/jquery-3.7.1.min.js" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="css/style.css">
</head>

<body>
  <div class="container">
    <header>
            <ul class="nav nav-tabs" id="navId" role="tablist">
                <li class="nav-item">
                    <a href="#tab1Id" class="nav-link active" data-bs-toggle="tab">Mesas</a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#" role="button">Módulos</a>
                    <div class="dropdown-menu">
                        <a class="dropdown-item" href="usuario.html">Usuarios</a>
                        <a class="dropdown-item" href="empleado.html">Empleados</a>
                        <a class="dropdown-item" href="cliente.html">Clientes</a>
                        <a class="dropdown-item" href="#">Categorias Menu</a>
                        <a class="dropdown-item" href="#">Platillos</a>
                        <a class="dropdown-item" href="#">Ingredientes</a>
                        <a class="dropdown-item" href="pedido.html">Pedidos</a>
                        <a class="dropdown-item" href="reserva.html">Reservas</a>
                        <a class="dropdown-item" href="proveedor.html">Proveedores</a>
                        <a class="dropdown-item" href="venta.html">Ventas</a>
                    </div>
                </li>
            </ul>
        </header>

    <h1>Mesas</h1>

    <div class="mb-3">
      <label for="numero" class="form-label">Número de Mesa</label>
      <input type="number" class="form-control" id="numero" />
    </div>
    <div class="mb-3">
      <label for="capacidad" class="form-label">Capacidad</label>
      <input type="number" class="form-control" id="capacidad" />
    </div>
    <div class="mb-3">
      <label for="estado" class="form-label">Estado</label>
      <select class="form-select" id="estado">
        <option value="libre">Libre</option>
        <option value="ocupada">Ocupada</option>
        <option value="reservada">Reservada</option>
        <option value="en_limpieza">En limpieza</option>
      </select>
    </div>

    <div class="mb-3">
      <a id="guardardatos" class="btn btn-primary" role="button">Guardar</a>
      <a id="actualizardatos" class="btn btn-success" style="display: none;" role="button">Actualizar</a>
      <input onclick="limpiarFormulario()" class="btn btn-danger" type="button" value="Limpiar" />
    </div>

    <div class="table-responsive">
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>Número</th>
            <th>Capacidad</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="listadatos"></tbody>
      </table>
    </div>
  </div>

  <script>
    const API_URL = 'http://localhost:3000/api/mesa/';
    let mesaId = null;

    function limpiarFormulario() {
      $("#numero").val("");
      $("#capacidad").val("");
      $("#estado").val("libre");
      $("#guardardatos").show();
      $("#actualizardatos").hide();
      mesaId = null;
    }

    function cargarDatos() {
      $.get(API_URL, function (data) {
        $("#listadatos").empty();
        data.forEach((item) => {
          $("#listadatos").append(`
            <tr>
              <td>${item.numero}</td>
              <td>${item.capacidad}</td>
              <td>${item.estado}</td>
              <td>
                <a class="btn btn-primary btn-sm" onclick="editarDatos('${item._id}','${item.numero}','${item.capacidad}','${item.estado}')">Editar</a>
                <a class="btn btn-danger btn-sm" onclick="eliminarDatos('${item._id}')">Eliminar</a>
              </td>
            </tr>
          `);
        });
      });
    }

    $("#guardardatos").click(function () {
      const nuevaMesa = {
        numero: $("#numero").val(),
        capacidad: $("#capacidad").val(),
        estado: $("#estado").val()
      };

      $.ajax({
        url: API_URL,
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(nuevaMesa),
        success: function () {
          alert("Mesa registrada");
          limpiarFormulario();
          cargarDatos();
        },
        error: function (err) {
          alert("Error al guardar: " + err.responseText);
        }
      });
    });

    window.editarDatos = function (id, numero, capacidad, estado) {
      mesaId = id;
      $("#numero").val(numero);
      $("#capacidad").val(capacidad);
      $("#estado").val(estado);
      $("#guardardatos").hide();
      $("#actualizardatos").show();

      $("#actualizardatos").off().click(function () {
        const actualizada = {
          numero: $("#numero").val(),
          capacidad: $("#capacidad").val(),
          estado: $("#estado").val()
        };

        $.ajax({
          url: API_URL + mesaId,
          type: "PUT",
          contentType: "application/json",
          data: JSON.stringify(actualizada),
          success: function () {
            alert("Mesa actualizada");
            limpiarFormulario();
            cargarDatos();
          },
          error: function (err) {
            alert("Error al actualizar: " + err.responseText);
          }
        });
      });
    };

    window.eliminarDatos = function (id) {
      if (confirm("¿Eliminar esta mesa?")) {
        $.ajax({
          url: API_URL + id,
          type: "DELETE",
          success: function () {
            alert("Mesa eliminada");
            cargarDatos();
          },
          error: function (err) {
            alert("Error al eliminar: " + err.responseText);
          }
        });
      }
    };

    $(document).ready(cargarDatos);
  </script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"></script>
</body>

</html>