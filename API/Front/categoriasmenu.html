<!doctype html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <title>Categorías Menú</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <link rel="stylesheet" href="css/style.css">
</head>

<body>
  <div class="container">
    <header>
      <ul class="nav nav-tabs">
        <li class="nav-item">
          <a href="index.html" class="nav-link active" role="button">Inicio</a>
        </li>
        <li class="nav-item">
          <a href="#" class="nav-link active">Categorías Menú</a>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#">Módulos</a>
          <div class="dropdown-menu">
            <a class="dropdown-item" href="usuario.html">Usuarios</a>
            <a class="dropdown-item" href="empleado.html">Empleados</a>
            <a class="dropdown-item" href="cliente.html">Clientes</a>
            <a class="dropdown-item" href="platillos.html">Platillos</a>
            <a class="dropdown-item" href="ingredientes.html">Ingredientes</a>
            <a class="dropdown-item" href="pedido.html">Pedidos</a>
            <a class="dropdown-item" href="detalles_pedido.html">Detalles Pedidos</a>
            <a class="dropdown-item" href="mesas.html">Mesas</a>
            <a class="dropdown-item" href="reserva.html">Reservas</a>
            <a class="dropdown-item" href="proveedor.html">Proveedores</a>
            <a class="dropdown-item" href="venta.html">Ventas</a>
          </div>
        </li>
      </ul>
    </header>

    <h1>Categorías Menú</h1>

    <div class="mb-3">
      <label for="nombre" class="form-label">Nombre</label>
      <input type="text" class="form-control" id="nombre">
    </div>
    <div class="mb-3">
      <label for="descripcion" class="form-label">Descripción</label>
      <textarea class="form-control" id="descripcion"></textarea>
    </div>

    <div class="mb-3">
      <button id="guardar" class="btn btn-primary">Guardar</button>
      <button id="actualizar" class="btn btn-success" style="display:none">Actualizar</button>
      <button id="limpiar" class="btn btn-danger">Limpiar</button>
    </div>

    <div class="table-responsive">
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Descripción</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="lista"></tbody>
      </table>
    </div>
  </div>

  <script>
    const API_URL = 'http://localhost:3000/api/categorias-menu';
    let categoriaId = null;

    $(document).ready(() => {
      cargarCategorias();

      $('#guardar').click(guardarCategoria);
      $('#actualizar').click(actualizarCategoria);
      $('#limpiar').click(limpiarFormulario);
    });

    function cargarCategorias() {
      $.get(API_URL, (data) => {
        $('#lista').empty();
        data.forEach(categoria => {
          const id = categoria._id?.$oid || categoria._id;
          $('#lista').append(`
        <tr>
          <td>${categoria.nombre}</td>
          <td>${categoria.descripcion || ''}</td>
          <td>
            <button class="btn btn-warning btn-sm" 
              onclick="editarCategoria('${id}')">Editar</button>
            <button class="btn btn-danger btn-sm" 
              onclick="eliminarCategoria('${id}')">Eliminar</button>
          </td>
        </tr>
      `);
        });
      }).fail(err => {
        console.error('Error al cargar categorías:', err);
      });
    }

    function guardarCategoria() {
      const datos = {
        nombre: $('#nombre').val(),
        descripcion: $('#descripcion').val()
      };

      $.ajax({
        url: API_URL,
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(datos),
        success: function () {
          alert("Categoría registrada");
          limpiarFormulario();
          cargarCategorias();
        },
        error: function (err) {
          console.error('Error al guardar:', err.responseText);
          alert('Error al guardar: ' + err.responseText);
        }
      });
    }

    function actualizarCategoria() {
      const datos = {
        nombre: $('#nombre').val(),
        descripcion: $('#descripcion').val()
      };

      $.ajax({
        url: `${API_URL}/${categoriaId}`,
        type: 'PUT',
        contentType: 'application/json',
        data: JSON.stringify(datos),
        success: function () {
          alert("Categoría actualizada");
          limpiarFormulario();
          cargarCategorias();
        },
        error: function (err) {
          console.error('Error al actualizar:', err.responseText);
          alert('Error al actualizar: ' + err.responseText);
        }
      });
    }

    function editarCategoria(id) {
      const cleanedId = id.replace(/[^a-f0-9]/gi, '');

      if (cleanedId.length !== 24) {
        alert('ID inválido. Debe tener 24 caracteres hexadecimales.');
        return;
      }

      $.ajax({
        url: `${API_URL}/${cleanedId}`,
        type: 'GET',
        dataType: 'json',
        success: function (categoria) {
          $('#nombre').val(categoria.nombre);
          $('#descripcion').val(categoria.descripcion || '');
          categoriaId = cleanedId;
          $('#guardar').hide();
          $('#actualizar').show();
        },
        error: function (xhr) {
          console.error('Error al cargar categoría:', xhr);
          alert('Error al cargar categoría');
        }
      });
    }

    function eliminarCategoria(id) {
      if (confirm('¿Eliminar esta categoría?')) {
        $.ajax({
          url: `${API_URL}/${id}`,
          type: 'DELETE',
          success: function () {
            alert('Categoría eliminada');
            cargarCategorias();
          },
          error: function (err) {
            alert('Error al eliminar: ' + (err.responseJSON?.message || err.statusText));
          }
        });
      }
    }

    function limpiarFormulario() {
      $('#nombre').val('');
      $('#descripcion').val('');
      categoriaId = null;
      $('#guardar').show();
      $('#actualizar').hide();
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>