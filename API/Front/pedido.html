<!doctype html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <title>Pedidos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://code.jquery.com/jquery-3.7.1.min.js" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="css/style.css">
</head>

<body>
  <div class="container">
    <header>
      <ul class="nav nav-tabs" id="navId" role="tablist">
        <li class="nav-item">
          <a href="#tab1Id" class="nav-link active" data-bs-toggle="tab">Pedidos</a>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#" role="button">Módulos</a>
          <div class="dropdown-menu">
            <a class="dropdown-item" href="usuario.html">Usuarios</a>
            <a class="dropdown-item" href="empleado.html">Empleados</a>
            <a class="dropdown-item" href="cliente.html">Clientes</a>
            <a class="dropdown-item" href="categoriasmenu.html">Categorías Menú</a>
            <a class="dropdown-item" href="platillos.html">Platillos</a>
            <a class="dropdown-item" href="ingredientes.html">Ingredientes</a>
            <a class="dropdown-item" href="detalles_pedido.html">Detalles Pedidos</a>
            <a class="dropdown-item" href="mesas.html">Mesas</a>
            <a class="dropdown-item" href="reserva.html">Reservas</a>
            <a class="dropdown-item" href="proveedor.html">Proveedores</a>
            <a class="dropdown-item" href="venta.html">Ventas</a>
          </div>
        </li>
      </ul>
    </header>

    <h1>Pedidos</h1>

    <div class="mb-3">
      <label for="cliente" class="form-label">Cliente</label>
      <input type="text" class="form-control" id="cliente" />
    </div>
    <div class="mb-3">
      <label for="mesero" class="form-label">Mesero</label>
      <input type="text" class="form-control" id="mesero" />
    </div>
    <div class="mb-3">
      <label for="fecha" class="form-label">Fecha</label>
      <input type="date" class="form-control" id="fecha" />
    </div>
    <div class="mb-3">
      <label for="estado" class="form-label">Estado</label>
      <select class="form-select" id="estado">
        <option value="pendiente">Pendiente</option>
        <option value="en_proceso">En proceso</option>
        <option value="completado">Completado</option>
      </select>
    </div>
    <div class="mb-3">
      <label for="total" class="form-label">Total</label>
      <input type="number" class="form-control" id="total" />
    </div>

    <div class="mb-3">
      <a id="guardardatos" class="btn btn-primary" role="button">Guardar</a>
      <a id="actualizardatos" class="btn btn-success" style="display: none;" role="button">Actualizar</a>
      <input onclick="limpiarFormulario()" class="btn btn-danger" type="button" value="Limpiar" />
    </div>

    <div class="table-responsive">
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>ID</th>
            <th>Cliente</th>
            <th>Mesero</th>
            <th>Fecha</th>
            <th>Estado</th>
            <th>Total</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="listadatos"></tbody>
      </table>
    </div>
  </div>

  <script>
    const API_URL = 'http://localhost:3000/api/pedidos/';

    function limpiarFormulario() {
      $("#cliente").val("");
      $("#mesero").val("");
      $("#fecha").val("");
      $("#estado").val("pendiente");
      $("#total").val("");
      $("#guardardatos").show();
      $("#actualizardatos").hide();
    }

    function cargarDatos() {
      $.get(API_URL, function (data) {
        $("#listadatos").empty();
        data.forEach((item) => {
          $("#listadatos").append(`
            <tr>
              <td>${item._id}</td>
              <td>${item.cliente}</td>
              <td>${item.mesero}</td>
              <td>${item.fecha?.substring(0, 10)}</td>
              <td>${item.estado}</td>
              <td>${item.total}</td>
              <td>
                <a class="btn btn-primary btn-sm" onclick="editarDatos('${item._id}','${item.cliente}','${item.mesero}','${item.fecha?.substring(0, 10)}','${item.estado}','${item.total}')">Editar</a>
                <a class="btn btn-danger btn-sm" onclick="eliminarDatos('${item._id}')">Eliminar</a>
              </td>
            </tr>
          `);
        });
      });
    }

    $("#guardardatos").click(function () {
      const nuevo = {
        cliente: $("#cliente").val(),
        mesero: $("#mesero").val(),
        fecha: $("#fecha").val(),
        estado: $("#estado").val(),
        total: parseFloat($("#total").val())
      };

      $.ajax({
        url: API_URL,
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(nuevo),
        success: function () {
          alert("Pedido guardado");
          limpiarFormulario();
          cargarDatos();
        },
        error: function (err) {
          alert("Error al guardar: " + err.responseText);
        }
      });
    });

    window.editarDatos = function (id, cliente, mesero, fecha, estado, total) {
      $("#cliente").val(cliente);
      $("#mesero").val(mesero);
      $("#fecha").val(fecha);
      $("#estado").val(estado);
      $("#total").val(total);
      $("#guardardatos").hide();
      $("#actualizardatos").show();

      $("#actualizardatos").off().click(function () {
        const actualizado = {
          cliente: $("#cliente").val(),
          mesero: $("#mesero").val(),
          fecha: $("#fecha").val(),
          estado: $("#estado").val(),
          total: parseFloat($("#total").val())
        };

        $.ajax({
          url: API_URL + id,
          type: "PUT",
          contentType: "application/json",
          data: JSON.stringify(actualizado),
          success: function () {
            alert("Pedido actualizado");
            limpiarFormulario();
            cargarDatos();
          },
          error: function (err) {
            alert("Error al actualizar: " + err.responseText);
          }
        });
      });
    };

    window.eliminarDatos = function (id) {
      if (confirm("¿Eliminar este pedido?")) {
        $.ajax({
          url: API_URL + id,
          type: "DELETE",
          success: function () {
            alert("Pedido eliminado");
            cargarDatos();
          },
          error: function (err) {
            alert("Error al eliminar: " + err.responseText);
          }
        });
      }
    };

    $(document).ready(cargarDatos);
  </script>

  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"></script>
</body>

</html>