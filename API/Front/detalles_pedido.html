<!doctype html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <title>Detalles del Pedido</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://code.jquery.com/jquery-3.7.1.min.js" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="css/style.css">
</head>

<body>
  <div class="container">
    <header>
            <ul class="nav nav-tabs" id="navId" role="tablist">
                <li class="nav-item">
                    <a href="#tab1Id" class="nav-link active" data-bs-toggle="tab">Detalles Pedidos</a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#" role="button">Módulos</a>
                    <div class="dropdown-menu">
                        <a class="dropdown-item" href="usuario.html">Usuarios</a>
                        <a class="dropdown-item" href="empleado.html">Empleados</a>
                        <a class="dropdown-item" href="cliente.html">Clientes</a>
                        <a class="dropdown-item" href="#">Categorias Menu</a>
                        <a class="dropdown-item" href="#">Platillos</a>
                        <a class="dropdown-item" href="#">Ingredientes</a>
                        <a class="dropdown-item" href="pedido.html">Pedidos</a>
                        <a class="dropdown-item" href="mesas.html">Mesas</a>
                        <a class="dropdown-item" href="reserva.html">Reservas</a>
                        <a class="dropdown-item" href="proveedor.html">Proveedores</a>
                        <a class="dropdown-item" href="venta.html">Ventas</a>
                    </div>
                </li>
            </ul>
        </header>

    <h1>Detalles del Pedido</h1>

    <div class="mb-3">
      <label for="pedido_id" class="form-label">ID Pedido</label>
      <input type="text" class="form-control" id="pedido_id" />
    </div>
    <div class="mb-3">
      <label for="plato_id" class="form-label">ID Plato</label>
      <input type="text" class="form-control" id="plato_id" />
    </div>
    <div class="mb-3">
      <label for="cantidad" class="form-label">Cantidad</label>
      <input type="number" class="form-control" id="cantidad" />
    </div>
    <div class="mb-3">
      <label for="notas" class="form-label">Notas</label>
      <input type="text" class="form-control" id="notas" />
    </div>

    <div class="mb-3">
      <a id="guardardatos" class="btn btn-primary" role="button">Guardar</a>
      <a id="actualizardatos" class="btn btn-success" style="display: none;" role="button">Actualizar</a>
      <input onclick="limpiarFormulario()" class="btn btn-danger" type="button" value="Limpiar" />
    </div>

    <div class="table-responsive">
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>Pedido</th>
            <th>Plato</th>
            <th>Cantidad</th>
            <th>Notas</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="listadatos"></tbody>
      </table>
    </div>
  </div>

  <script>
    const API_URL = 'http://localhost:3000/api/detalles_pedido/';

    function limpiarFormulario() {
      $("#pedido_id").val("");
      $("#plato_id").val("");
      $("#cantidad").val("");
      $("#notas").val("");
      $("#guardardatos").show();
      $("#actualizardatos").hide();
    }

    function cargarDatos() {
      $.get(API_URL, function (data) {
        $("#listadatos").empty();
        data.forEach((item) => {
          $("#listadatos").append(`
            <tr>
              <td>${item.pedido_id}</td>
              <td>${item.plato_id}</td>
              <td>${item.cantidad}</td>
              <td>${item.notas}</td>
              <td>
                <a class="btn btn-primary btn-sm" onclick="editarDatos('${item._id}','${item.pedido_id}','${item.plato_id}','${item.cantidad}','${item.notas}')">Editar</a>
                <a class="btn btn-danger btn-sm" onclick="eliminarDatos('${item._id}')">Eliminar</a>
              </td>
            </tr>
          `);
        });
      });
    }

    $("#guardardatos").click(function () {
      const nuevo = {
        pedido_id: $("#pedido_id").val(),
        plato_id: $("#plato_id").val(),
        cantidad: $("#cantidad").val(),
        notas: $("#notas").val()
      };

      $.ajax({
        url: API_URL,
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(nuevo),
        success: function () {
          alert("Detalle guardado");
          limpiarFormulario();
          cargarDatos();
        },
        error: function (err) {
          alert("Error al guardar: " + err.responseText);
        }
      });
    });

    window.editarDatos = function (id, pedido_id, plato_id, cantidad, notas) {
      $("#pedido_id").val(pedido_id);
      $("#plato_id").val(plato_id);
      $("#cantidad").val(cantidad);
      $("#notas").val(notas);
      $("#guardardatos").hide();
      $("#actualizardatos").show();

      $("#actualizardatos").off().click(function () {
        const actualizado = {
          pedido_id: $("#pedido_id").val(),
          plato_id: $("#plato_id").val(),
          cantidad: $("#cantidad").val(),
          notas: $("#notas").val()
        };

        $.ajax({
          url: API_URL + id,
          type: "PUT",
          contentType: "application/json",
          data: JSON.stringify(actualizado),
          success: function () {
            alert("Detalle actualizado");
            limpiarFormulario();
            cargarDatos();
          },
          error: function (err) {
            alert("Error al actualizar: " + err.responseText);
          }
        });
      });
    };

    window.eliminarDatos = function (id) {
      if (confirm("¿Eliminar este detalle?")) {
        $.ajax({
          url: API_URL + id,
          type: "DELETE",
          success: function () {
            alert("Detalle eliminado");
            cargarDatos();
          },
          error: function (err) {
            alert("Error al eliminar: " + err.responseText);
          }
        });
      }
    };

    $(document).ready(cargarDatos);
  </script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"></script>
</body>

</html>