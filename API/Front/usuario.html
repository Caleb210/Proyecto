<!doctype html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <title>Usuarios</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <div class="container">
        <header>
            <ul class="nav nav-tabs" id="navId" role="tablist">
                <li class="nav-item">
                    <a href="#tab1Id" class="nav-link active" data-bs-toggle="tab">Usuarios</a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#" role="button">Módulos</a>
                    <div class="dropdown-menu">
                        <a class="dropdown-item" href="empleado.html">Empleados</a>
                        <a class="dropdown-item" href="cliente.html">Clientes</a>
                        <a class="dropdown-item" href="categoriasmenu.html">Categorías Menú</a>
                        <a class="dropdown-item" href="platillos.html">Platillos</a>
                        <a class="dropdown-item" href="ingredientes.html">Ingredientes</a>
                        <a class="dropdown-item" href="pedido.html">Pedidos</a>
                        <a class="dropdown-item" href="detalles_pedido.html">Detalles Pedidos</a>
                        <a class="dropdown-item" href="mesas.html">Mesas</a>
                        <a class="dropdown-item" href="reserva.html">Reservas</a>
                        <a class="dropdown-item" href="proveedor.html">Proveedores</a>
                        <a class="dropdown-item" href="venta.html">Ventas</a>
                    </div>
                </li>
            </ul>
        </header>

        <h1>Usuarios</h1>

        <div class="mb-3">
            <label for="nombre" class="form-label">Nombre</label>
            <input type="text" class="form-control" id="nombre" />
        </div>
        <div class="mb-3">
            <label for="rol" class="form-label">Rol</label>
            <select class="form-select" id="rol">
                <option value="administrador">Administrador</option>
                <option value="mesero">Mesero</option>
                <option value="cocinero">Cocinero</option>
            </select>
        </div>
        <div class="mb-3">
            <label for="email" class="form-label">Email</label>
            <input type="email" class="form-control" id="email" />
        </div>
        <div class="mb-3">
            <label for="contraseña" class="form-label">Contraseña</label>
            <input type="password" class="form-control" id="contraseña" />
        </div>
        <div class="mb-3">
            <label for="fecha" class="form-label">Fecha Registro</label>
            <input type="date" class="form-control" id="fecha" />
        </div>

        <div class="mb-3">
            <a id="guardardatos" class="btn btn-primary" role="button">Guardar</a>
            <a id="actualizardatos" class="btn btn-success" style="display: none;" role="button">Actualizar</a>
            <input onclick="limpiarFormulario()" class="btn btn-danger" type="button" value="Limpiar" />
        </div>

        <div class="table-responsive">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Rol</th>
                        <th>Email</th>
                        <th>Contraseña</th>
                        <th>Fecha Registro</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="listadatos"></tbody>
            </table>
        </div>
    </div>
    <script>
        const API_URL = 'http://localhost:3000/api/usuario'; // Ajusta si tu ruta base es distinta
        let usuarioIdEditando = null;

        // Cargar datos al iniciar
        $(document).ready(function () {
            obtenerUsuarios();

            // Guardar nuevo usuario
            $('#guardardatos').click(function () {
                const usuario = obtenerDatosFormulario();
                if (!validarFormulario(usuario)) return;

                $.ajax({
                    url: API_URL,
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(usuario),
                    success: function () {
                        limpiarFormulario();
                        obtenerUsuarios();
                    },
                    error: function (err) {
                        console.error(err);
                        alert('Error al guardar usuario');
                    }
                });
            });

            // Actualizar usuario existente
            $('#actualizardatos').click(function () {
                const usuario = obtenerDatosFormulario();
                if (!validarFormulario(usuario)) return;

                $.ajax({
                    url: `${API_URL}/${usuarioIdEditando}`,
                    method: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify(usuario),
                    success: function () {
                        limpiarFormulario();
                        obtenerUsuarios();
                        $('#guardardatos').show();
                        $('#actualizardatos').hide();
                        usuarioIdEditando = null;
                    },
                    error: function (err) {
                        console.error(err);
                        alert('Error al actualizar usuario');
                    }
                });
            });
        });

        // Obtener usuarios y mostrarlos
        function obtenerUsuarios() {
            $.get(API_URL, function (usuarios) {
                $('#listadatos').empty();
                usuarios.forEach(usuario => {
                    $('#listadatos').append(`
                <tr>
                    <td>${usuario.nombre}</td>
                    <td>${usuario.rol}</td>
                    <td>${usuario.email}</td>
                    <td>${usuario.contraseña}</td>
                    <td>${formatearFecha(usuario.fecha_registro)}</td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="editarUsuario('${usuario._id}')">Editar</button>
                        <button class="btn btn-danger btn-sm" onclick="eliminarUsuario('${usuario._id}')">Eliminar</button>
                    </td>
                </tr>
            `);
                });
            });
        }

        // Editar usuario
        function editarUsuario(id) {
            $.get(`${API_URL}/${id}`, function (usuario) {
                $('#nombre').val(usuario.nombre);
                $('#rol').val(usuario.rol);
                $('#email').val(usuario.email);
                $('#contraseña').val(usuario.contraseña);
                $('#fecha').val(usuario.fecha_registro ? usuario.fecha_registro.split('T')[0] : '');
                usuarioIdEditando = id;
                $('#guardardatos').hide();
                $('#actualizardatos').show();
            });
        }

        // Eliminar usuario
        function eliminarUsuario(id) {
            if (confirm('¿Seguro que deseas eliminar este usuario?')) {
                $.ajax({
                    url: `${API_URL}/${id}`,
                    method: 'DELETE',
                    success: function () {
                        obtenerUsuarios();
                    },
                    error: function (err) {
                        console.error(err);
                        alert('Error al eliminar usuario');
                    }
                });
            }
        }

        // Obtener datos del formulario
        function obtenerDatosFormulario() {
            return {
                nombre: $('#nombre').val(),
                rol: $('#rol').val(),
                email: $('#email').val(),
                contraseña: $('#contraseña').val(),
                fecha_registro: $('#fecha').val()
            };
        }

        // Limpiar formulario
        function limpiarFormulario() {
            $('#nombre').val('');
            $('#rol').val('administrador');
            $('#email').val('');
            $('#contraseña').val('');
            $('#fecha').val('');
            $('#guardardatos').show();
            $('#actualizardatos').hide();
            usuarioIdEditando = null;
        }

        // Validar datos
        function validarFormulario(usuario) {
            if (!usuario.nombre || !usuario.rol || !usuario.email || !usuario.contraseña) {
                alert('Todos los campos son obligatorios');
                return false;
            }
            return true;
        }

        // Formatear fecha
        function formatearFecha(fecha) {
            if (!fecha) return '';
            const d = new Date(fecha);
            return d.toISOString().split('T')[0];
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"></script>
</body>

</html>